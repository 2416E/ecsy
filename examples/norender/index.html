<!DOCTYPE html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <link rel="stylesheet" href="">
  </head>
  <body>
    <script type="module">
      import {World, System, Not} from '../../../build/ecsy.module.js';

      import {Rotating, Pulsating, InputState, Transform} from './components.mjs';
      import {RotatingSystem, InputSystem} from './systems.mjs';

      class TestSystem extends System {
        init() {
          return {
            queries: {
              entities: {components: [Rotating, Transform]}
            }
          };
        }

        execute(delta) {
          let entities = this.queries.entities;
          for (var i = 0; i < entities.length; i++) {
            var entity = entities[i];
            var rotating = entity.getComponent(Rotating);
            var rotatingSpeed = rotating.rotatingSpeed;
            //var transform = entity.getMutableComponent(Transform);
            //transform.rotation.x += rotatingSpeed;
          }
        }
      }

      class MyNot extends System {
        init() {
          return {
            queries: {
              transRot: { components: [Transform, Rotating, Not(Pulsating)] }
              /*all: { components: [Transform, Rotating, Pulsating] },
              transRot: { components: [Transform, Rotating] },
              pulsating: { components: [Pulsating] },
              transRotNotPulsating: { components: [Transform, Rotating, Not(Pulsating)] },*/
            }
          };
        }
      }

      class MyReactiveSystem extends System {
        init() {
          return {
            queries: {
              transformRotating: {
                components: [Transform, Rotating],
                listen: {
                  added: true,
                  removed: true,
                  changed: true
                }
              },
              rotating: {
                components: [Rotating],
                listen: {
                  added: true,
                  removed: true,
                  changed: true
                }
              },
              transformRotating2: {
                components: [Transform, Rotating],
                listen: {
                  added: true,
                  removed: true,
                  changed: [Transform]
                }
              }
            }
          }
        }

        execute() {
          // Transform&Rotating
          if (this.queries.transformRotating.results.length > 0) {
            //console.log('results', this.queries.transformRotating.results);
          }

          if (this.queries.transformRotating.added.length > 0) {
            console.log('Transform&Rotating OnAdded', this.queries.transformRotating.added);
          }

          if (this.queries.transformRotating.removed.length > 0) {
            console.log('Transform&Rotating Onremoved', this.queries.transformRotating.removed);
          }

          if (this.queries.transformRotating.changed.length > 0) {
            console.log('Transform&Rotating Onchanged', this.queries.transformRotating.changed);
          }

          // Transform&Rotating2
          if (this.queries.transformRotating2.added.length > 0) {
            console.log('Transform&Rotating2 OnAdded', this.queries.transformRotating2.added);
          }

          if (this.queries.transformRotating2.removed.length > 0) {
            console.log('Transform&Rotating2 Onremoved', this.queries.transformRotating2.removed);
          }

          if (this.queries.transformRotating2.changed.transform.length > 0) {
            console.log('Transform&Rotating2 Onchanged[Transform]', this.queries.transformRotating2.changed.transform);
          }

          // Rotating
          if (this.queries.rotating.added.length > 0) {
            console.log('Rotating OnAdded', this.queries.rotating.added);
          }

          if (this.queries.rotating.removed.length > 0) {
            console.log('Rotating Onremoved', this.queries.rotating.removed);
          }

          if (this.queries.rotating.changed.length > 0) {
            console.log('Rotating Onchanged', this.queries.rotating.changed);
          }
        }
      }

      var world = new World();

      world
        .registerComponent(Rotating)
        .registerComponent(Pulsating)
        .registerComponent(Transform)
        .registerSystem(MyReactiveSystem)
        //.registerSystem(MyNot);

      // Used for singleton components
      var singletonEntity = world.createEntity();
      singletonEntity.addComponent(InputState);

      for (var i = 0; i < 10; i++)Â {
        var entity = world.createEntity();
        entity
          .addComponent(Rotating, {rotationSpeed: 0.2})
          .addComponent(Transform);

        if (i >= 5) {
          entity
            .addComponent(Pulsating);
        }
      }

      world.entityManager._entities[6].removeComponent(Pulsating);

      window.world = world;
      window.World = World;
      window.Transform = Transform;
      window.Rotating = Rotating;
      window.MyReactiveSystem = MyReactiveSystem;

      function animate() {
        var time = performance.now();
        var delta = time - lastTime;
        world.execute(delta, time);
        lastTime = time;
        requestAnimationFrame(animate);
      }

      var lastTime = performance.now();
      animate();
    </script>
  </body>
</html>